{"version":3,"sources":["/js/api.ts"],"names":[],"mappings":"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","file":"api.js","sourcesContent":["import {Store, format, Languages} from '/js/util';\r\n\r\n\r\ninterface AjaxMessage {\r\n\tdata ?: any,\r\n\terror ?: string\r\n}\r\n\r\ninterface ApiCall {\r\n\t(param: any, callback?: Function): void;\r\n\r\n\t(callback: Function): void;\r\n\r\n\tset(key: string, value: any): this;\r\n\r\n\tget(key: string): any\r\n}\r\n\r\ninterface IApiConfig {\r\n\t(apiSets: HashMap<string>): void\r\n\r\n\t[key: string]: ApiCall\r\n}\r\n\r\n//noinspection TypeScriptUnresolvedVariable\r\n//cfg.apiServer = window.apiServer ;\r\n\r\nconst apiServer = window['CONFIG'].apiServer || '/api/';\r\nconst loginPage = __uri('/pages/login/index.html');\r\n\r\nlet onServerError = function (code:number, errorMsg:string , callback?:Function) {\r\n\tif (code === 401 && location.pathname != loginPage) {\r\n\t\tlocation.href = loginPage;\r\n\t}\r\n\telse {\r\n\t\t//mui.alert(`api.${this.name} error ${code} (${errorMsg})`, 'error: ', 'OK');\r\n\t\tmui.alert(`api.${this.name} error (${errorMsg})`, 'error: ', 'OK');\r\n\t}\r\n};\r\n\r\nlet loading = {\r\n\tdom: $('#opgAjaxLoading').hide(),\r\n\thandlers: 0,\r\n\ttimer: 0,\r\n\tshow: function () {\r\n\t\tloading.dom.stop(true, true).fadeIn();\r\n\t},\r\n\thide: function () {\r\n\t\tif (!loading.handlers)\r\n\t\t\tloading.dom.stop(true, true).fadeOut();\r\n\t}\r\n};\r\n\r\n\r\nconst xToken = (function () {\r\n\tlet token = Store.get('Authorization');\r\n\tif (token) {\r\n\t\treturn {\r\n\t\t\tAuthorization: 'Bearer ' + token,\r\n\t\t\tlng: Languages.current\r\n\t\t};\r\n\t}\r\n\telse {\r\n\t\treturn {\r\n\t\t\tlng: Languages.current\r\n\t\t};\r\n\t}\r\n})();\r\n\r\n//console.log(xToken);\r\n\r\n\r\nclass ServerFn {\r\n\r\n\tname: string;\r\n\tmethod: string;\r\n\trestful: boolean;\r\n\turl: string;\r\n\r\n\tunlimited: boolean;\r\n\taccessible: boolean;\r\n\ttimeOut: number; //in milliseconds\r\n\r\n\tonError?: Function;\r\n\r\n\r\n\tconstructor(url: string, name: string, method = 'GET', restful = true) {\r\n\r\n\t\tthis.name = name;\r\n\t\tthis.method = method;\r\n\t\tthis.restful = restful;\r\n\t\tthis.timeOut = 30000;\r\n\r\n\t\tif (url.indexOf('http://') === 0 || url.indexOf('https://') === 0) this.url = url;\r\n\t\telse this.url = apiServer + url.replace(/^\\//, '');\r\n\r\n\r\n\t\tthis.unlimited = false;\r\n\t\tthis.accessible = true;\r\n\r\n\t}\r\n\r\n\thandleError(code , error, callback) {\r\n\t\tif (typeof this.onError === 'function')\r\n\t\t\treturn this.onError.call(this, code , error, callback);\r\n\t\telse\r\n\t\t\treturn onServerError.call(this, code , error, callback);\r\n\t}\r\n\r\n\tinvoke(data, callback): JQueryXHR {\r\n\t\tlet that = this;\r\n\r\n\t\tif (this.accessible || this.unlimited) {\r\n\t\t\tthis.accessible = false;\r\n\t\t\t//return $[this.method].apply(this, makeParam.call(this, data, callback, type || 'json'));\r\n\t\t\tif ($.isFunction(data)) {\r\n\t\t\t\tcallback = data;\r\n\t\t\t\tdata = null;\r\n\t\t\t}\r\n\r\n\r\n\t\t\tlet url = this.url, method = this.method;\r\n\t\t\tlet contentType: string | boolean = 'application/json';\r\n\t\t\tlet processData: boolean = true;\r\n\r\n\t\t\tif (method === 'UPLOAD') {\r\n\t\t\t\tcontentType = false;\r\n\t\t\t\tprocessData = false;\r\n\t\t\t\tmethod = 'POST';\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tif (data) {\r\n\t\t\t\t\tif (this.method != 'GET') {\r\n\t\t\t\t\t\tdata = JSON.stringify(data);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\r\n\t\t\treturn $.ajax({\r\n\t\t\t\theaders: xToken,\r\n\t\t\t\tcontentType: contentType,\r\n\t\t\t\tprocessData: processData,\r\n\t\t\t\tdataType: 'json',\r\n\t\t\t\turl: url,\r\n\t\t\t\tdata: data,\r\n\t\t\t\tmethod: method,\r\n\t\t\t\tcache: false,\r\n\t\t\t\ttimeout: that.timeOut,\r\n\t\t\t\tbeforeSend: function (jqXHR: JQueryXHR, settings: JQueryAjaxSettings) {\r\n\t\t\t\t\tloading.handlers++;\r\n\r\n\t\t\t\t\tif (loading.timer) clearTimeout(loading.timer);\r\n\t\t\t\t\tloading.timer = 0;\r\n\t\t\t\t\tloading.show();\r\n\r\n\t\t\t\t},\r\n\t\t\t\tcomplete: function () {\r\n\t\t\t\t\tloading.handlers--;\r\n\t\t\t\t\tif (loading.timer)\r\n\t\t\t\t\t\tclearTimeout(loading.timer);\r\n\r\n\t\t\t\t\tloading.timer = setTimeout(loading.hide, 100);\r\n\r\n\t\t\t\t\tthat.accessible = true;\r\n\t\t\t\t\tthat = null;\r\n\r\n\t\t\t\t\treturn data;\r\n\t\t\t\t},\r\n\t\t\t\terror: function (jqXHR: JQueryXHR, textStatus: string, errorThrown: string) {\r\n\t\t\t\t\tlet code: number = jqXHR.status;\r\n\r\n\t\t\t\t\tif (jqXHR.responseJSON && jqXHR.responseJSON.error) {\r\n\t\t\t\t\t\tthat.handleError.call(that, code, jqXHR.responseJSON.error, callback);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tif (!errorThrown)\r\n\t\t\t\t\t\t\terrorThrown = 'server connection lost';\r\n\r\n\t\t\t\t\t\tthat.handleError.call(that, code, errorThrown, callback);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function (json: AjaxMessage, textStatus: string, jqXHR: JQueryXHR) {\r\n\r\n\t\t\t\t\tlet error = json.error;\r\n\r\n\t\t\t\t\tif (error) {\r\n\t\t\t\t\t\tthat.handleError.call(that , 200 , error, callback);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tif (callback && typeof callback === 'function')\r\n\t\t\t\t\t\t\tcallback.call(that ,json.data === undefined ? {} : json.data, textStatus, jqXHR);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthrow new Error('Server function [' + this.name + '] unusable now.');\r\n\t\t}\r\n\t}\r\n}\r\n\r\n\r\nlet api: IApiConfig = function (apiSet: HashMap<string>) {\r\n\r\n\tfor (let key: string in apiSet) {\r\n\t\tlet uArr = key.split('!');\r\n\t\tlet pName = uArr[0];\r\n\t\tlet pMethod = uArr[1] ? uArr[1].toString().toUpperCase() : 'GET';\r\n\t\tlet restful = (!(uArr[2] === undefined)) || (apiSet[key].indexOf('${') > -1);\r\n\r\n\t\tif (!api[pName]) {\r\n\t\t\tapi[pName] = (function (srvFn: ServerFn) {\r\n\r\n\t\t\t\tlet fn: ApiCall = <ApiCall> function (data, callback) {\r\n\t\t\t\t\treturn srvFn.invoke.call(srvFn, data, callback);\r\n\t\t\t\t};\r\n\r\n\t\t\t\tfn.set = (k, v) => {\r\n\t\t\t\t\tsrvFn[k] = v;\r\n\t\t\t\t\treturn fn;\r\n\t\t\t\t};\r\n\r\n\t\t\t\tfn.get = (k: string) => srvFn[k];\r\n\r\n\t\t\t\tfn.toString = () => srvFn.url;\r\n\r\n\t\t\t\t/*fn.post = (data , cb)=>{\r\n\t\t\t\t fn.set('method' , 'POST') ;\r\n\t\t\t\t return fn(data , cb);\r\n\t\t\t\t };*/\r\n\r\n\r\n\t\t\t\treturn fn;\r\n\t\t\t})(new ServerFn(apiSet[key], pName, pMethod, restful));\r\n\t\t}\r\n\t\telse {\r\n\t\t\t//throw new Error('api [' + pName + '] duplicate definition');\r\n\t\t\tconsole.error(`api [${pName}] duplicate definition`);\r\n\t\t}\r\n\t}\r\n\r\n\treturn api;\r\n};\r\n\r\n\r\nexport {api, AjaxMessage} ;"]}